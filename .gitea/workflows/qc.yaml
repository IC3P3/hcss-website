name: QC Stage

on:
    push:
        branches:
          - '**'
        tags:
          - 'v*'
    pull_request:
        branches:
          - 'main'
          - 'dev'

jobs:
    lint:
        name: Lint
        runs-on: ${{ vars.DEFAULT_RUNNER || 'ubuntu-latest' }}
        if: ${{ gitea.event_name != 'pull_request' || (gitea.base_ref != 'dev' && gitea.base_ref != 'main') }}
        continue-on-error: true
        steps:
            - uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                version: 10.10.0

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 22

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run linting
              run: pnpm run lint

    lint-strict:
        name: Strict Linting
        runs-on: ${{ vars.DEFAULT_RUNNER || 'ubuntu-latest' }}
        if: ${{ gitea.event_name == 'pull_request' && (gitea.base_ref == 'dev' || gitea.base_ref == 'main') }}
        continue-on-error: false
        steps:
            - uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                version: 10.10.0

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 22

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run strict linting
              run: pnpm run lint:strict

    check:
        name: Type Check
        runs-on: ${{ vars.DEFAULT_RUNNER || 'ubuntu-latest' }}
        continue-on-error: ${{ gitea.event_name != 'pull_request' || (gitea.base_ref != 'dev' && gitea.base_ref != 'main') }}
        steps:
            - uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                version: 10.10.0

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 22

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run type check
              run: pnpm run check
